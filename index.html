<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Soundboard â€“ ì²­ì·¨ì</title>

<style>
:root { --bg:#0f1115; --card:#171a21; --muted:#8a93a6; --accent:#6ee7b7; --text:#e8ecf3; }
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
}
header{
  padding:16px 20px;border-bottom:1px solid #222732;background:#0c0f14;
}
h1{margin:0;font-size:18px;font-weight:700}
main{
  max-width:820px;margin:0 auto;padding:20px;
  display:flex;flex-direction:column;gap:16px;
}
.panel{
  background:var(--card);border:1px solid #222732;
  border-radius:14px;padding:14px;
}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{
  background:#232939;color:var(--text);
  border:1px solid #2c3347;border-radius:10px;
  padding:10px 14px;cursor:pointer;font-weight:600;
}
.btn-accent{
  background:linear-gradient(90deg,#10b981,#34d399);
  color:#0b0f14;border:0
}
input[type="text"]{
  background:#0b0f14;border:1px solid #22314b;
  border-radius:10px;padding:10px 12px;color:var(--text)
}
.small{font-size:12px;color:var(--muted)}
.meter{display:flex;gap:8px;align-items:center}
.mono{font-family:ui-monospace,monospace}
</style>
</head>

<body>

<header>
  <h1>ì‚¬ìš´ë“œë³´ë“œ ì²­ì·¨ì</h1>
  <div class="small">ê³µìœ  ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  ì—°ê²°í•˜ì„¸ìš”</div>
</header>

<main>
  <section class="panel">
    <div class="row">
      <input id="codeInput" class="mono" placeholder="ê³µìœ  ì½”ë“œ" />
      <button id="connectBtn" class="btn btn-accent">ì—°ê²°</button>
      <button id="disconnectBtn" class="btn">í•´ì œ</button>
      <span id="status" class="small">ëŒ€ê¸° ì¤‘â€¦</span>
    </div>
  </section>

  <section class="panel">
    <div class="row">
      <button id="pauseBtn" class="btn">ì •ì§€(ë¡œì»¬)</button>
      <button id="resumeBtn" class="btn">ì´ì–´ë“£ê¸°</button>
      <div class="meter">
        <span class="small">ë³¼ë¥¨</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" />
        <span id="volVal" class="small">0.90</span>
      </div>
    </div>
  </section>
</main>

<!-- ğŸ”´ ì²« ì½”ë“œì˜ í•µì‹¬: autoplay + playsinline -->
<audio id="remoteAudio" autoplay playsinline></audio>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
const codeInput = document.getElementById('codeInput');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const statusEl = document.getElementById('status');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const vol = document.getElementById('vol');
const volVal = document.getElementById('volVal');
const remoteAudio = document.getElementById('remoteAudio');

let peer = null;
let dataConn = null;

/* ğŸ”¹ AudioContextëŠ” â€œìˆìœ¼ë©´ ì“°ê³  ì—†ì–´ë„ ë¨â€ */
let audioCtx = null;
let gainNode = null;

function setStatus(t){ statusEl.textContent = t; }

/* ================= ì—°ê²° ================= */
connectBtn.onclick = async () => {
  const code = codeInput.value.trim();
  if (!code) return alert('ê³µìœ  ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  if (peer) return;

  peer = new Peer(undefined, {
    debug: 1,
    config: {
      iceServers: [{ urls:'stun:stun.l.google.com:19302' }]
    }
  });

  setStatus('ì—°ê²° ì¤‘â€¦');

  peer.on('open', () => {
    dataConn = peer.connect(code);
    dataConn.on('open', () => setStatus('ì—°ê²°ë¨ Â· ì˜¤ë””ì˜¤ ëŒ€ê¸°'));
  });

  peer.on('call', (call) => {
    call.answer(null); // ğŸ”µ ì²« ì½”ë“œ ë°©ì‹ ê·¸ëŒ€ë¡œ

    call.on('stream', async (stream) => {
      /* ğŸ”´ í•µì‹¬ ë³µêµ¬ 1: ì§ì ‘ ì¬ìƒ */
      remoteAudio.srcObject = stream;
      remoteAudio.volume = vol.value;

      try {
        await remoteAudio.play();
      } catch(e) {
        console.warn('autoplay ì°¨ë‹¨, ìˆ˜ë™ ì¬ê°œ í•„ìš”');
      }

      /* ğŸ”µ ë³´ì¡°: AudioContext (ì•ˆ ë˜ë©´ ë¬´ì‹œ) */
      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext||window.webkitAudioContext)();
          const src = audioCtx.createMediaElementSource(remoteAudio);
          gainNode = audioCtx.createGain();
          gainNode.gain.value = vol.value;
          src.connect(gainNode).connect(audioCtx.destination);
        }
        await audioCtx.resume();
      } catch(e){}

      setStatus('ê°™ì´ ë“£ëŠ” ì¤‘ ğŸ§');
    });
  });

  peer.on('error', e => {
    console.error(e);
    setStatus('ì˜¤ë¥˜ ë°œìƒ');
  });
};

/* ================= í•´ì œ ================= */
disconnectBtn.onclick = () => {
  try{ dataConn && dataConn.close(); }catch{}
  try{ peer && peer.destroy(); }catch{}
  peer = null; dataConn = null;

  remoteAudio.pause();
  remoteAudio.srcObject = null;

  setStatus('ì—°ê²° í•´ì œë¨');
};

/* ================= ì»¨íŠ¸ë¡¤ ================= */
pauseBtn.onclick = () => remoteAudio.pause();
resumeBtn.onclick = () => remoteAudio.play();

vol.oninput = () => {
  volVal.textContent = (+vol.value).toFixed(2);
  remoteAudio.volume = vol.value;
  if (gainNode) gainNode.gain.value = vol.value;
};
</script>

</body>
</html>
