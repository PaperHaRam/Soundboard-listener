<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Soundboard â€“ Listener</title>

<style>
:root {
  --bg:#0f1115; --card:#171a21; --muted:#8a93a6;
  --accent:#6ee7b7; --text:#e8ecf3;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
}
header{
  padding:16px 20px;border-bottom:1px solid #222732;
  background:#0c0f14;
}
h1{margin:0;font-size:18px;font-weight:700}
main{
  max-width:820px;margin:0 auto;padding:20px;
  display:flex;flex-direction:column;gap:16px;
}
.panel{
  background:var(--card);border:1px solid #222732;
  border-radius:14px;padding:14px;
}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{
  background:#232939;color:var(--text);
  border:1px solid #2c3347;border-radius:10px;
  padding:10px 14px;cursor:pointer;font-weight:600;
}
.btn:hover{border-color:#3b435c}
.btn-accent{
  background:linear-gradient(90deg,#10b981,#34d399);
  color:#0b0f14;border:0;
}
input[type="text"]{
  background:#0b0f14;border:1px solid #22314b;
  border-radius:10px;padding:10px 12px;
  color:var(--text);outline:none;
}
.small{font-size:12px;color:var(--muted)}
.meter{display:flex;gap:8px;align-items:center}
.mono{
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
}
</style>
</head>

<body>

<header>
  <h1>ì‚¬ìš´ë“œë³´ë“œ ì²­ì·¨ì</h1>
  <div class="small">ê³µìœ  ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  ë°˜ë“œì‹œ â€œì—°ê²°(ì†Œë¦¬ ì¼œê¸°)â€ë¥¼ ëˆ„ë¥´ì„¸ìš”</div>
</header>

<main>
  <section class="panel">
    <div class="row">
      <input id="codeInput" type="text" class="mono"
        placeholder="ê³µìœ  ì½”ë“œ (ì˜ˆ: 7K3M9X)" maxlength="12" />
      <button id="connectBtn" class="btn btn-accent">
        ì—°ê²° (ì†Œë¦¬ ì¼œê¸°)
      </button>
      <button id="disconnectBtn" class="btn">ì—°ê²° í•´ì œ</button>
      <span id="status" class="small">ëŒ€ê¸° ì¤‘â€¦</span>
    </div>
  </section>

  <section class="panel">
    <div class="row">
      <button id="pauseBtn" class="btn">ì •ì§€(ë¡œì»¬)</button>
      <button id="resumeBtn" class="btn">ì´ì–´ ë“£ê¸°</button>
      <div class="meter">
        <span class="small">ë³¼ë¥¨</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" />
        <span id="volVal" class="small">0.90</span>
      </div>
    </div>
    <div class="small" style="margin-top:6px">
      â€¢ ì •ì§€ëŠ” ë‚´ ê¸°ê¸°ì—ì„œë§Œ ì ìš©ë©ë‹ˆë‹¤.<br/>
      â€¢ ìµœì´ˆ ì—°ê²°ì€ ë°˜ë“œì‹œ ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ í•´ì•¼ í•©ë‹ˆë‹¤.
    </div>
  </section>
</main>

<!-- ì‹¤ì œ ì˜¤ë””ì˜¤ ì—”ì§„ -->
<audio id="remoteAudio" playsinline></audio>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
/* ================= DOM ================= */
const codeInput = document.getElementById('codeInput');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const statusEl = document.getElementById('status');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const vol = document.getElementById('vol');
const volVal = document.getElementById('volVal');
const remoteAudio = document.getElementById('remoteAudio');

/* ================= Audio ================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let sourceNode = null;
let gainNode = null;

async function setupAudio(stream) {
  if (!audioCtx) {
    audioCtx = new AudioCtx();
    gainNode = audioCtx.createGain();
    gainNode.gain.value = parseFloat(vol.value);
    gainNode.connect(audioCtx.destination);
  }

  // ğŸ”´ WebRTC ì˜¤ë””ì˜¤ëŠ” ë°˜ë“œì‹œ audio íƒœê·¸ì— ì—°ê²°
  remoteAudio.srcObject = stream;
  remoteAudio.muted = true; // ì—ì½” ë°©ì§€
  await remoteAudio.play();

  if (!sourceNode) {
    sourceNode = audioCtx.createMediaElementSource(remoteAudio);
    sourceNode.connect(gainNode);
  }

  if (audioCtx.state !== 'running') {
    await audioCtx.resume();
  }
}

/* ================= Peer ================= */
let peer = null;
let dataConn = null;

function setStatus(t){ statusEl.textContent = t; }

/* ================= Connect ================= */
connectBtn.onclick = async () => {
  const code = (codeInput.value || '').trim();
  if (!code) { alert('ê³µìœ  ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (peer) { alert('ì´ë¯¸ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤'); return; }

  peer = new Peer(undefined, {
    debug: 1,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    }
  });

  setStatus('ì‹ í˜¸ ì„œë²„ ì—°ê²° ì¤‘â€¦');

  peer.on('open', () => {
    dataConn = peer.connect(code);
    dataConn.on('open', () => setStatus('ì—°ê²°ë¨ Â· ì˜¤ë””ì˜¤ ëŒ€ê¸° ì¤‘'));
    dataConn.on('close', () => setStatus('ë°ì´í„° ì—°ê²° ì¢…ë£Œ'));
  });

  peer.on('call', (call) => {
    // Safari ëŒ€ì‘
    call.answer(new MediaStream());

    call.on('stream', async (remoteStream) => {
      await setupAudio(remoteStream);
      setStatus('ì˜¤ë””ì˜¤ ìˆ˜ì‹  ì¤‘ ğŸ§');
    });
  });

  peer.on('error', (err) => {
    console.error(err);
    alert('Peer ì˜¤ë¥˜: ' + err.message);
    setStatus('ì˜¤ë¥˜ ë°œìƒ');
  });

  peer.on('disconnected', () => {
    setStatus('ì‹ í˜¸ ì„œë²„ ì—°ê²° ëŠê¹€ (ì¬ì‹œë„ ì¤‘)');
    peer.reconnect();
  });
};

/* ================= Disconnect ================= */
disconnectBtn.onclick = () => {
  try { dataConn && dataConn.close(); } catch {}
  try { peer && peer.destroy(); } catch {}
  peer = null;
  dataConn = null;

  try {
    remoteAudio.pause();
    remoteAudio.srcObject = null;
  } catch {}

  if (audioCtx) {
    audioCtx.close();
    audioCtx = null;
    sourceNode = null;
    gainNode = null;
  }

  setStatus('ì—°ê²° í•´ì œë¨');
};

/* ================= Controls ================= */
pauseBtn.onclick = () => {
  audioCtx && audioCtx.suspend();
};

resumeBtn.onclick = async () => {
  audioCtx && await audioCtx.resume();
};

vol.oninput = () => {
  const v = parseFloat(vol.value);
  volVal.textContent = v.toFixed(2);
  if (gainNode) gainNode.gain.value = v;
};
</script>

</body>
</html>
